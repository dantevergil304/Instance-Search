from sklearn.svm import LinearSVC
from feature_extraction import extract_feature_from_face
from keras.engine import Model
from keras_vggface.vggface import VGGFace
from keras import backend as K

import pickle
import json
import os


def isGoodFace_classifier(face_img, classifier_type="linear_svm_fc7"):
    with open('../cfg/config.json', 'r') as f:
        config = json.load(f)
    with open(os.path.join(
            config["models"]["Good_bad_face_classifier_folder"], f'{classifier_type}.pkl'), 'rb') as f:
        classifier = pickle.load(f)

    # Get Deep Model for extracting features
    if classifier_type == 'linear_svm_fc7':
        vgg_model = VGGFace(input_shape=(224, 224, 3), pooling='avg')
        out = vgg_model.get_layer('fc7').output
        model = Model(vgg_model.input, out)
    elif classifier_type == 'linear_svm_resnet50':
        vgg_model = VGGFace(input_shape=(224, 224, 3),
                            pooling='avg', model='resnet50')
        out = vgg_model.get_layer('flatten_1').output
        model = Model(vgg_model.input, out)

    feat = extract_feature_from_face(model, face_img)
    K.clear_session()

    if classifier.predict(feat) == 1:
        return True
    return False
